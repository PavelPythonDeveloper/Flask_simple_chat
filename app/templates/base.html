<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link type="text/css" href="{{url_for('static', filename='style.css') }}" rel="stylesheet">
    <title>Simple Chat</title>
</head>
<body>
<div>
    <div class="logo">
        <img src="#">
    </div>
    <form action="" method="get">
        <input name="s" placeholder="Search here..." type="search">
        <button type="submit">Go!</button>
    </form>
    {% if current_user.is_authenticated %}
    <a href="{{ url_for('logout') }}" class="login-button">Logout</a>
    <a href="#" class="messages-button">Messages <span id="message-counter"></span></a>
    <a href="#" class="profile-button">Profile</a>
    {% endif %}
</div>
<hr>
{% with messages = get_flashed_messages() %}
{% if messages %}
<ul>
    {% for message in messages %}
    <li> {{ message }}</li>
    {% endfor %}
</ul>
{% endif %}
{% endwith %}
{% block content %}
{% endblock %}
</body>
<script>
function setMessageCounter(count){
    let messageCounter = document.querySelector("#message-counter");
    messageCounter.innerHTML = count;
};

function get_chats()
{
    let request = new XMLHttpRequest();
    var params = 'userId=' + encodeURIComponent({{current_user.id}});
    request.open("GET", "/_get_chats?" + params, true);
    request.send();
    request.onload = function()
	{
        if (request.status != 200)
		{
            alert(`Error ${request.status}: ${request.statusText}`);
        } else
				{
					document.querySelectorAll(".chat").forEach(el => el.remove());
					let response = JSON.parse(request.response);
					for (var key in response)
						{
							let div = document.createElement('div');
							div.className = "chat";
							div.id = key;
							let chatName = key;
							let userName = response[key].users.username
							let lastMessage = response[key].last_message
							div.innerHTML = chatName + " " + userName + " " + lastMessage;
							document.querySelector('#chat-holder').append(div);

						}
				}
                    const chats = document.getElementsByClassName("chat");

                    const chatSelected = e => {
                        document.querySelectorAll(".message").forEach(el => el.remove());
                        console.log(e.target.id);

                        let requestMessage = new XMLHttpRequest();
                        var params = 'chat_Id=' + encodeURIComponent(e.target.id);
                        requestMessage.open("GET", "/_get_chat_messages?" + params, true);
                        requestMessage.send();
                        requestMessage.onload = function()
                        {
                            let response = JSON.parse(requestMessage.response);
                            console.log(response);
                            let k = 0;
                            for (let key in response)
                            {
                                let divMessages = document.createElement('div');
                                divMessages.className = "message";
                                text = response[key].body;
                                divMessages.innerHTML = text;
                                document.querySelector('#message-holder').append(divMessages);
                            }
                        }
                    }

                    for (let chat of chats) {
                        console.log(chat.id);
                        chat.addEventListener("click", chatSelected);
                        }

                setMessageCounter(6)
    }

}
get_chats();
let timerId = setInterval(() => get_chats(), 4000);
</script>
</html>